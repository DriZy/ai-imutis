name: CI/CD

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: gcr.io
  IMAGE_NAME: ai-imutis-api
  KUBE_NAMESPACE: ai-imutis

jobs:
  # Syntax and compile checks
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Static import check
        run: |
          python -m compileall app
      
      - name: Check YAML files
        run: |
          for file in k8s/*.yaml helm/ai-imutis/values*.yaml; do
            echo "Validating $file"
            if command -v yamllint &> /dev/null; then
              yamllint -d relaxed "$file"
            fi
          done

  # Docker build and push
  docker:
    needs: lint
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker

      - name: Extract metadata
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          else
            TAG=${{ github.sha }}
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
            ${{ steps.meta.outputs.image }}:latest
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_NAME }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.meta.outputs.tag }}

  # Kubernetes deployment (only on main branch)
  deploy:
    needs: docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} \
            --region=${{ secrets.GKE_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Extract metadata
        id: meta
        run: |
          echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT

      - name: Run database migrations
        run: |
          kubectl set image deployment/api \
            api=${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }} \
            -n ${{ env.KUBE_NAMESPACE }} \
            --record
          kubectl wait --for=condition=progressing deployment/api \
            -n ${{ env.KUBE_NAMESPACE }} \
            --timeout=600s || true

      - name: Deploy via Helm
        run: |
          helm upgrade --install ai-imutis ./helm/ai-imutis \
            --namespace ${{ env.KUBE_NAMESPACE }} \
            --set api.image.tag=${{ steps.meta.outputs.tag }} \
            --set global.projectId=${{ secrets.GCP_PROJECT_ID }} \
            --timeout 10m \
            --wait

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/api \
            -n ${{ env.KUBE_NAMESPACE }} \
            --timeout=600s

      - name: Check pod health
        run: |
          kubectl get pods -n ${{ env.KUBE_NAMESPACE }} -l app=api
          kubectl logs -n ${{ env.KUBE_NAMESPACE }} \
            -l app=api \
            --tail=50

  # Load testing (optional, triggered on release tags)
  load-test:
    if: startsWith(github.ref, 'refs/tags/')
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust
        run: |
          pip install locust

      - name: Get API endpoint
        id: api
        run: |
          API_URL=$(kubectl get ingress -n ${{ env.KUBE_NAMESPACE }} \
            -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')
          echo "url=http://${API_URL}" >> $GITHUB_OUTPUT

      - name: Run load test
        run: |
          locust -f locustfile.py \
            --host=${{ steps.api.outputs.url }} \
            --users=100 \
            --spawn-rate=10 \
            --run-time=5m \
            --headless

  # Notify on failure
  notify:
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify on failure
        run: |
          echo "Deployment failed. Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
