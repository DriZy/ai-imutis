# yaml
name: CI/CD

on:
  push:
    branches: [ main, master, staging, develop ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, master ]

env:
  IMAGE_NAME: ai-imutis-api
  DOCKER_REGISTRY: docker.io
  KUBE_NAMESPACE_STAGING: staging
  KUBE_NAMESPACE_PROD: production

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Static import check
        run: |
          python -m compileall app

      - name: Run ruff linter
        run: |
          pip install ruff
          ruff check .

      - name: Check YAML files
        run: |
          pip install yamllint || true
          for file in k8s/*.yaml helm/ai-imutis/values*.yaml; do
            echo "Validating $file"
            if command -v yamllint &> /dev/null; then
              yamllint -d relaxed "$file"
            fi
          done

  docker:
    needs: lint
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          else
            TAG=${GITHUB_SHA::8}
          fi
          IMAGE="${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
            ${{ steps.meta.outputs.image }}:latest
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_NAME }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.meta.outputs.tag }}

  deploy-staging:
    needs: docker
    if: startsWith(github.ref, 'refs/heads/staging') || startsWith(github.ref, 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install doctl and authenticate
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Configure kubeconfig (staging)
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DO_K8S_CLUSTER_STAGING }}

      - name: Update staging deployment image
        run: |
          IMAGE="${{ needs.docker.outputs.image }}:${{ needs.docker.outputs.tag }}"
          kubectl set image deployment/api api=$IMAGE -n ${{ env.KUBE_NAMESPACE_STAGING }} --record
          kubectl rollout status deployment/api -n ${{ env.KUBE_NAMESPACE_STAGING }} --timeout=600s

      - name: Tail staging pod logs (last 100 lines)
        run: |
          kubectl get pods -n ${{ env.KUBE_NAMESPACE_STAGING }} -l app=api -o name | head -n1 | xargs -I{} kubectl logs {} -n ${{ env.KUBE_NAMESPACE_STAGING }} --tail=100 || true

  deploy-production:
    needs: docker
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install doctl and authenticate
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Configure kubeconfig (production)
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DO_K8S_CLUSTER_PROD }}

      - name: Update production deployment image
        run: |
          IMAGE="${{ needs.docker.outputs.image }}:${{ needs.docker.outputs.tag }}"
          kubectl set image deployment/api api=$IMAGE -n ${{ env.KUBE_NAMESPACE_PROD }} --record
          kubectl rollout status deployment/api -n ${{ env.KUBE_NAMESPACE_PROD }} --timeout=600s

      - name: Tail production pod logs (last 100 lines)
        run: |
          kubectl get pods -n ${{ env.KUBE_NAMESPACE_PROD }} -l app=api -o name | head -n1 | xargs -I{} kubectl logs {} -n ${{ env.KUBE_NAMESPACE_PROD }} --tail=100 || true

  notify:
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify on failure
        run: |
          echo "Deployment failed. Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"