#apiVersion: v1
#kind: Service
#metadata:
#  name: api
#  namespace: ai-imutis
#  labels:
#    app: api
#spec:
#  type: ClusterIP
#  selector:
#    app: api
#  ports:
#  - name: http
#    port: 80
#    targetPort: 8000
#    protocol: TCP
#  sessionAffinity: None
#
#
#apiVersion: v1
#kind: Service
#metadata:
#  name: api-headless
#  namespace: ai-imutis
#  labels:
#    app: api
#spec:
#  type: ClusterIP
#  clusterIP: None
#  selector:
#    app: api
#  ports:
#  - name: http
#    port: 8000
#    targetPort: 8000
#    protocol: TCP
#
#---
#apiVersion: apps/v1
#kind: Deployment
#metadata:
#  name: api
#  namespace: ai-imutis
#  labels:
#    app: api
#    version: v1
#spec:
#  replicas: 3
#  strategy:
#    type: RollingUpdate
#    rollingUpdate:
#      maxSurge: 1
#      maxUnavailable: 0
#  selector:
#    matchLabels:
#      app: api
#  template:
#    metadata:
#      labels:
#        app: api
#        version: v1
#      annotations:
#        prometheus.io/scrape: "true"
#        prometheus.io/port: "8000"
#        prometheus.io/path: "/metrics"
#    spec:
#      securityContext:
#        runAsNonRoot: true
#        runAsUser: 1000
#        fsGroup: 1000
#
#      serviceAccountName: api-sa
#
#      affinity:
#        podAntiAffinity:
#          preferredDuringSchedulingIgnoredDuringExecution:
#          - weight: 100
#            podAffinityTerm:
#              labelSelector:
#                matchExpressions:
#                - key: app
#                  operator: In
#                  values:
#                  - api
#              topologyKey: kubernetes.io/hostname
#        nodeAffinity:
#          requiredDuringSchedulingIgnoredDuringExecution:
#            nodeSelectorTerms:
#            - matchExpressions:
#              - key: workload
#                operator: In
#                values:
#                - api
#
#      terminationGracePeriodSeconds: 30
#
#      initContainers:
#image: gcr.io/your-gcp-project/ai-imutis-api:1.0.0
#        imagePullPolicy: Always
#
#        securityContext:
#          allowPrivilegeEscalation: false
#          capabilities:
#            drop:
#              - ALL
#          readOnlyRootFilesystem: false
#
#        command:
#        - /bin/sh
#        - -c
#        - |
#          set -e
#          echo "Waiting for PostgreSQL..."
#          timeout 60 sh -c 'until nc -z postgres 5432; do echo waiting; sleep 2; done'
#          echo "Running Alembic migrations..."
#          alembic upgrade head
#          echo "Seeding data..."
#          python -c "from app.seed import seed_data; import asyncio; asyncio.run(seed_data())"
#
#        env:
#        - name: DATABASE_URL
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: database-url
#        - name: REDIS_URL
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: redis-url
#        - name: FIREBASE_PROJECT_ID
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: firebase-project-id
#        - name: FIREBASE_SERVICE_ACCOUNT_JSON
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: firebase-service-account-json
#
#        resources:
#          requests:
#            cpu: "100m"
#            memory: "256Mi"
#          limits:
#            cpu: "500m"
#            memory: "512Mi"
#
#      containers:
#      - name: api
#        image: gcr.io/your-gcp-project/ai-imutis-api:1.0.0
#        imagePullPolicy: Always
#
#        securityContext:
#          allowPrivilegeEscalation: false
#          capabilities:
#            drop:
#              - ALL
#          readOnlyRootFilesystem: false
#
#        ports:
#        - name: http
#          containerPort: 8000
#          protocol: TCP
#
#        env:
#        # Required secrets
#        - name: DATABASE_URL
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: database-url
#        - name: REDIS_URL
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: redis-url
#        - name: FIREBASE_PROJECT_ID
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: firebase-project-id
#        - name: FIREBASE_SERVICE_ACCOUNT_JSON
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: firebase-service-account-json
#        - name: SENTRY_DSN
#          valueFrom:
#            secretKeyRef:
#              name: api-secrets
#              key: sentry-dsn
#
#        # ConfigMap settings
#        - name: API_ENVIRONMENT
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: API_ENVIRONMENT
#        - name: API_VERSION
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: API_VERSION
#        - name: API_DEBUG
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: API_DEBUG
#        - name: LOG_LEVEL
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: LOG_LEVEL
#        - name: CORS_ORIGINS
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: CORS_ORIGINS
#        - name: RATE_LIMIT_ANONYMOUS
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: RATE_LIMIT_ANONYMOUS
#        - name: RATE_LIMIT_AUTHENTICATED
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: RATE_LIMIT_AUTHENTICATED
#        - name: RATE_LIMIT_PREMIUM
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: RATE_LIMIT_PREMIUM
#        - name: RATE_LIMIT_AI
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: RATE_LIMIT_AI
#        - name: RATE_LIMIT_BOOKING
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: RATE_LIMIT_BOOKING
#        - name: OTEL_JAEGER_ENDPOINT
#          valueFrom:
#            configMapKeyRef:
#              name: api-config
#              key: OTEL_JAEGER_ENDPOINT
#
#        # Pod metadata for observability
#        - name: POD_NAME
#          valueFrom:
#            fieldRef:
#              fieldPath: metadata.name
#        - name: POD_NAMESPACE
#          valueFrom:
#            fieldRef:
#              fieldPath: metadata.namespace
#        - name: POD_IP
#          valueFrom:
#            fieldRef:
#              fieldPath: status.podIP
#
#        resources:
#          requests:
#            cpu: "250m"
#            memory: "512Mi"
#          limits:
#            cpu: "1000m"
#            memory: "1Gi"
#
#        livenessProbe:
#          httpGet:
#            path: /health
#            port: 8000
#            scheme: HTTP
#          initialDelaySeconds: 20
#          periodSeconds: 10
#          timeoutSeconds: 5
#          failureThreshold: 3
#
#        readinessProbe:
#          httpGet:
#            path: /health
#            port: 8000
#            scheme: HTTP
#          initialDelaySeconds: 10
#          periodSeconds: 5
#          timeoutSeconds: 3
#          failureThreshold: 3
#
#        startupProbe:
#          httpGet:
#            path: /health
#            port: 8000
#            scheme: HTTP
#          initialDelaySeconds: 0
#          periodSeconds: 10
#          timeoutSeconds: 3
#          failureThreshold: 30
#
#        # Graceful shutdown: wait for readiness probe to fail (signals draining)
#        lifecycle:
#          preStop:
#            exec:
#              command:
#              - /bin/sh
#              - -c
#              - sleep 15
#
#      imagePullSecrets:
#      - name: docker-registry
#
#---
#apiVersion: v1
#kind: ServiceAccount
#metadata:
#  name: api-sa
#  namespace: ai-imutis
#
#---
#apiVersion: rbac.authorization.k8s.io/v1
#kind: Role
#metadata:
#  name: api-role
#  namespace: ai-imutis
#rules:
#- apiGroups: [""]
#  resources: ["configmaps"]
#  verbs: ["get", "list", "watch"]
#- apiGroups: [""]
#  resources: ["secrets"]
#  verbs: ["get"]
#
#---
#apiVersion: rbac.authorization.k8s.io/v1
#kind: RoleBinding
#metadata:
#  name: api-rolebinding
#  namespace: ai-imutis
#roleRef:
#  apiGroup: rbac.authorization.k8s.io
#  kind: Role
#  name: api-role
#subjects:
#- kind: ServiceAccount
#  name: api-sa
#  namespace: ai-imutis
#
#---
#apiVersion: policy/v1
#kind: PodDisruptionBudget
#metadata:
#  name: api-pdb
#  namespace: ai-imutis
#spec:
#  minAvailable: 2
#  selector:
#    matchLabels:
#      app: api
