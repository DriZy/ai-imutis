# Default values for ai-imutis Helm chart

# Global settings
global:
  environment: production
  domain: api.example.com
  imageRegistry: gcr.io
  projectId: your-gcp-project
  imagePullPolicy: Always
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000

# API Deployment settings
api:
  enabled: true
  replicaCount: 3
  
  image:
    repository: ai-imutis-api
    tag: "1.0.0"
    pullPolicy: IfNotPresent
  
  imagePullSecrets: []
  
  serviceAccount:
    create: true
    name: api-sa
    annotations: {}
  
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 8000
  
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/rate-limit: "100"
    hosts:
      - host: api.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: api-tls-cert
        hosts:
          - api.example.com
  
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  livenessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  startupProbe:
    httpGet:
      path: /health
      port: 8000
    initialDelaySeconds: 0
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 30
  
  env:
    API_ENVIRONMENT: production
    API_VERSION: "1.0.0"
    LOG_LEVEL: INFO
    CORS_ALLOW_CREDENTIALS: "true"
    RATE_LIMIT_ANONYMOUS: "30"
    RATE_LIMIT_AUTHENTICATED: "100"
    RATE_LIMIT_PREMIUM: "500"
    RATE_LIMIT_AI: "1000"
    RATE_LIMIT_BOOKING: "20"
  
  # Secrets (must be provided during deployment)
  secrets:
    databaseUrl: ""  # Set via --set or values-prod.yaml
    redisUrl: ""
    firebaseProjectId: ""
    firebaseServiceAccountJson: ""
    sentryDsn: ""
  
  # Migration settings
  migration:
    enabled: true
    timeout: 300
  
  # Pod disruption budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

# PostgreSQL StatefulSet
postgres:
  enabled: true
  replicaCount: 1
  
  image:
    repository: postgis/postgis
    tag: "16-3.4"
    pullPolicy: IfNotPresent
  
  auth:
    username: app_user
    password: ""  # Set via secrets
    postgresPassword: ""  # Set via secrets
    database: ai_imutis
  
  primary:
    resources:
      limits:
        cpu: 2000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 512Mi
    
    persistence:
      enabled: true
      size: 50Gi
      storageClassName: fast-ssd
    
    livenessProbe:
      initialDelaySeconds: 30
      periodSeconds: 10
    
    readinessProbe:
      initialDelaySeconds: 10
      periodSeconds: 5
  
  initdb:
    scripts:
      01-postgis.sql: |
        CREATE EXTENSION IF NOT EXISTS postgis;
        CREATE EXTENSION IF NOT EXISTS postgis_topology;
        CREATE EXTENSION IF NOT EXISTS uuid-ossp;
  
  pdb:
    create: true
    minAvailable: 1

# Redis StatefulSet
redis:
  enabled: true
  replicaCount: 1
  
  image:
    repository: redis
    tag: "7-alpine"
    pullPolicy: IfNotPresent
  
  auth:
    enabled: false  # Set to true and provide password for production
    password: ""
  
  master:
    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 256Mi
    
    persistence:
      enabled: true
      size: 20Gi
      storageClassName: fast-ssd
  
  pdb:
    create: true
    minAvailable: 1

# Prometheus Monitoring
prometheus:
  enabled: true
  
  prometheusSpec:
    retention: 15d
    
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 250m
        memory: 512Mi
    
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: fast-ssd
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
  
  # Alert rules
  additionalPrometheusRulesMap:
    api-alerts:
      groups:
        - name: api-alerts
          interval: 30s
          rules:
            - alert: APIHighErrorRate
              expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
              for: 5m
              labels:
                severity: critical
            - alert: APIHighLatency
              expr: histogram_quantile(0.95, http_request_duration_seconds_bucket) > 1
              for: 5m
              labels:
                severity: warning

# ConfigMap for application settings
config:
  corsOrigins: "https://frontend.example.com,https://app.example.com"
  logLevel: INFO
  features:
    aiEnabled: true
    notificationsEnabled: true
    analyticsEnabled: true

# Network Policy
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress

# RBAC
rbac:
  create: true

# Storage
storage:
  storageClass: fast-ssd
  defaultSize: 10Gi

# Logging
logging:
  enabled: true
  format: json
  level: INFO
